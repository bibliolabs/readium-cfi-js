EPUBcfiParser=function(){function e(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function t(e,t,r,n,i,o){this.message=e,this.expected=t,this.found=r,this.offset=n,this.line=i,this.column=o,this.name="SyntaxError"}function r(e){function r(t){function r(t,r,n){var i,o;for(i=r;n>i;i++)o=e.charAt(i),"\n"===o?(t.seenCR||t.line++,t.column=1,t.seenCR=!1):"\r"===o||"\u2028"===o||"\u2029"===o?(t.line++,t.column=1,t.seenCR=!0):(t.column++,t.seenCR=!1)}return Xt!==t&&(Xt>t&&(Xt=0,$t={line:1,column:1,seenCR:!1}),r($t,Xt,t),Xt=t),$t}function n(e){zt>Gt||(Gt>zt&&(zt=Gt,Zt=[]),Zt.push(e))}function i(n,i,o){function a(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}function c(e,t){function r(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0180-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1080-\uFFFF]/g,function(e){return"\\u"+t(e)})}var n,i,o,a=new Array(e.length);for(o=0;o<e.length;o++)a[o]=e[o].description;return n=e.length>1?a.slice(0,-1).join(", ")+" or "+a[e.length-1]:a[0],i=t?'"'+r(t)+'"':"end of input","Expected "+n+" but "+i+" found."}var s=r(o),f=o<e.length?e.charAt(o):null;return null!==i&&a(i),new t(null!==n?n:c(i,f),i,f,o,s.line,s.column)}function o(){var t,r,i,o;return t=Gt,e.substr(Gt,8)===U?(r=U,Gt+=8):(r=O,0===Kt&&n(B)),r!==O?(i=a(),i===O&&(i=c()),i!==O?(41===e.charCodeAt(Gt)?(o=j,Gt++):(o=O,0===Kt&&n(b)),o!==O?(Wt=t,r=M(i),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function a(){var t,r,i,o,a,c,u;return t=Gt,r=f(),r!==O?(i=s(),i!==O?(44===e.charCodeAt(Gt)?(o=L,Gt++):(o=O,0===Kt&&n(k)),o!==O?(a=s(),a!==O?(44===e.charCodeAt(Gt)?(c=L,Gt++):(c=O,0===Kt&&n(k)),c!==O?(u=s(),u!==O?(Wt=t,r=q(r,i,a,u),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function c(){var e,t,r;return e=Gt,t=f(),t!==O?(r=s(),r!==O?(Wt=e,t=V(t,r),e=t):(Gt=e,e=D)):(Gt=e,e=D),e}function s(){var e,t,r;if(e=Gt,t=[],r=f(),r===O&&(r=u()),r!==O)for(;r!==O;)t.push(r),r=f(),r===O&&(r=u());else t=D;return t!==O?(r=d(),r===O&&(r=H),r!==O?(Wt=e,t=J(t,r),e=t):(Gt=e,e=D)):(Gt=e,e=D),e}function f(){var t,r,i,o,a,c,s;return t=Gt,47===e.charCodeAt(Gt)?(r=G,Gt++):(r=O,0===Kt&&n(W)),r!==O?(i=N(),i!==O?(o=Gt,91===e.charCodeAt(Gt)?(a=X,Gt++):(a=O,0===Kt&&n($)),a!==O?(c=p(),c!==O?(93===e.charCodeAt(Gt)?(s=z,Gt++):(s=O,0===Kt&&n(Z)),s!==O?(a=[a,c,s],o=a):(Gt=o,o=D)):(Gt=o,o=D)):(Gt=o,o=D),o===O&&(o=H),o!==O?(Wt=t,r=K(i,o),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function u(){var t,r,i,o,a,c,s;return t=Gt,e.substr(Gt,2)===Q?(r=Q,Gt+=2):(r=O,0===Kt&&n(Y)),r!==O?(i=N(),i!==O?(o=Gt,91===e.charCodeAt(Gt)?(a=X,Gt++):(a=O,0===Kt&&n($)),a!==O?(c=p(),c!==O?(93===e.charCodeAt(Gt)?(s=z,Gt++):(s=O,0===Kt&&n(Z)),s!==O?(a=[a,c,s],o=a):(Gt=o,o=D)):(Gt=o,o=D)):(Gt=o,o=D),o===O&&(o=H),o!==O?(Wt=t,r=et(i,o),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function d(){var t,r,i,o,a,c,s;return t=Gt,58===e.charCodeAt(Gt)?(r=tt,Gt++):(r=O,0===Kt&&n(rt)),r!==O?(i=N(),i!==O?(o=Gt,91===e.charCodeAt(Gt)?(a=X,Gt++):(a=O,0===Kt&&n($)),a!==O?(c=l(),c!==O?(93===e.charCodeAt(Gt)?(s=z,Gt++):(s=O,0===Kt&&n(Z)),s!==O?(a=[a,c,s],o=a):(Gt=o,o=D)):(Gt=o,o=D)):(Gt=o,o=D),o===O&&(o=H),o!==O?(Wt=t,r=nt(i,o),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function p(){var e,t;return e=Gt,t=m(),t!==O&&(Wt=e,t=it(t)),e=t}function l(){var e,t,r;return e=Gt,t=E(),t===O&&(t=H),t!==O?(r=h(),r===O&&(r=H),r!==O?(Wt=e,t=ot(t,r),e=t):(Gt=e,e=D)):(Gt=e,e=D),e}function h(){var t,r,i,o,a;return t=Gt,59===e.charCodeAt(Gt)?(r=at,Gt++):(r=O,0===Kt&&n(ct)),r!==O?(i=g(),i!==O?(61===e.charCodeAt(Gt)?(o=st,Gt++):(o=O,0===Kt&&n(ft)),o!==O?(a=g(),a!==O?(Wt=t,r=ut(i,a),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function E(){var t,r,i,o;return t=Gt,r=m(),r===O&&(r=H),r!==O?(44===e.charCodeAt(Gt)?(i=L,Gt++):(i=O,0===Kt&&n(k)),i!==O?(o=m(),o===O&&(o=H),o!==O?(Wt=t,r=dt(r,o),t=r):(Gt=t,t=D)):(Gt=t,t=D)):(Gt=t,t=D),t}function g(){var e,t,r;if(e=Gt,t=[],r=C(),r===O&&(r=F()),r!==O)for(;r!==O;)t.push(r),r=C(),r===O&&(r=F());else t=D;return t!==O&&(Wt=e,t=pt(t)),e=t}function m(){var e,t,r;if(e=Gt,t=[],r=C(),r===O&&(r=F(),r===O&&(r=I())),r!==O)for(;r!==O;)t.push(r),r=C(),r===O&&(r=F(),r===O&&(r=I()));else t=D;return t!==O&&(Wt=e,t=pt(t)),e=t}function C(){var e,t,r,n;return e=Gt,t=Gt,r=T(),r!==O?(n=T(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D),t===O&&(t=Gt,r=T(),r!==O?(n=S(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D),t===O&&(t=Gt,r=T(),r!==O?(n=y(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D),t===O&&(t=Gt,r=T(),r!==O?(n=v(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D),t===O&&(t=Gt,r=T(),r!==O?(n=x(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D),t===O&&(t=Gt,r=T(),r!==O?(n=w(),n!==O?(r=[r,n],t=r):(Gt=t,t=D)):(Gt=t,t=D)))))),t!==O&&(Wt=e,t=lt(t)),e=t}function N(){var t,r,i,o,a;if(t=Gt,48===e.charCodeAt(Gt)?(r=It,Gt++):(r=O,0===Kt&&n(Tt)),r===O)if(r=Gt,ht.test(e.charAt(Gt))?(i=e.charAt(Gt),Gt++):(i=O,0===Kt&&n(Et)),i!==O){for(o=[],gt.test(e.charAt(Gt))?(a=e.charAt(Gt),Gt++):(a=O,0===Kt&&n(mt));a!==O;)o.push(a),gt.test(e.charAt(Gt))?(a=e.charAt(Gt),Gt++):(a=O,0===Kt&&n(mt));o!==O?(i=[i,o],r=i):(Gt=r,r=D)}else Gt=r,r=D;return r!==O&&(Wt=t,r=St(r)),t=r}function I(){var t,r;return t=Gt,32===e.charCodeAt(Gt)?(r=yt,Gt++):(r=O,0===Kt&&n(vt)),r!==O&&(Wt=t,r=xt()),t=r}function T(){var t,r;return t=Gt,94===e.charCodeAt(Gt)?(r=wt,Gt++):(r=O,0===Kt&&n(Ft)),r!==O&&(Wt=t,r=Pt()),t=r}function S(){var t,r;return t=Gt,91===e.charCodeAt(Gt)?(r=X,Gt++):(r=O,0===Kt&&n($)),r===O&&(93===e.charCodeAt(Gt)?(r=z,Gt++):(r=O,0===Kt&&n(Z))),r!==O&&(Wt=t,r=At(r)),t=r}function y(){var t,r;return t=Gt,40===e.charCodeAt(Gt)?(r=Ot,Gt++):(r=O,0===Kt&&n(_t)),r===O&&(41===e.charCodeAt(Gt)?(r=j,Gt++):(r=O,0===Kt&&n(b))),r!==O&&(Wt=t,r=Rt(r)),t=r}function v(){var t,r;return t=Gt,44===e.charCodeAt(Gt)?(r=L,Gt++):(r=O,0===Kt&&n(k)),r!==O&&(Wt=t,r=Dt()),t=r}function x(){var t,r;return t=Gt,59===e.charCodeAt(Gt)?(r=at,Gt++):(r=O,0===Kt&&n(ct)),r!==O&&(Wt=t,r=Ut()),t=r}function w(){var t,r;return t=Gt,61===e.charCodeAt(Gt)?(r=st,Gt++):(r=O,0===Kt&&n(ft)),r!==O&&(Wt=t,r=Bt()),t=r}function F(){var t,r;return t=Gt,jt.test(e.charAt(Gt))?(r=e.charAt(Gt),Gt++):(r=O,0===Kt&&n(bt)),r===O&&(Mt.test(e.charAt(Gt))?(r=e.charAt(Gt),Gt++):(r=O,0===Kt&&n(Lt)),r===O&&(gt.test(e.charAt(Gt))?(r=e.charAt(Gt),Gt++):(r=O,0===Kt&&n(mt)),r===O&&(45===e.charCodeAt(Gt)?(r=kt,Gt++):(r=O,0===Kt&&n(qt)),r===O&&(95===e.charCodeAt(Gt)?(r=Vt,Gt++):(r=O,0===Kt&&n(Ht)),r===O&&(46===e.charCodeAt(Gt)?(r=Ct,Gt++):(r=O,0===Kt&&n(Nt))))))),r!==O&&(Wt=t,r=Jt(r)),t=r}var P,A=arguments.length>1?arguments[1]:{},O={},_={fragment:o},R=o,D=O,U="epubcfi(",B={type:"literal",value:"epubcfi(",description:'"epubcfi("'},j=")",b={type:"literal",value:")",description:'")"'},M=function(e){return{type:"CFIAST",cfiString:e}},L=",",k={type:"literal",value:",",description:'","'},q=function(e,t,r,n){return{type:"range",path:e,localPath:t,range1:r,range2:n}},V=function(e,t){return{type:"path",path:e,localPath:t}},H=null,J=function(e,t){return{steps:e,termStep:t?t:""}},G="/",W={type:"literal",value:"/",description:'"/"'},X="[",$={type:"literal",value:"[",description:'"["'},z="]",Z={type:"literal",value:"]",description:'"]"'},K=function(e,t){return{type:"indexStep",stepLength:e,idAssertion:t?t[1]:void 0}},Q="!/",Y={type:"literal",value:"!/",description:'"!/"'},et=function(e,t){return{type:"indirectionStep",stepLength:e,idAssertion:t?t[1]:void 0}},tt=":",rt={type:"literal",value:":",description:'":"'},nt=function(e,t){return{type:"textTerminus",offsetValue:e,textAssertion:t?t[1]:void 0}},it=function(e){return e},ot=function(e,t){return{type:"textLocationAssertion",csv:e?e:"",parameter:t?t:""}},at=";",ct={type:"literal",value:";",description:'";"'},st="=",ft={type:"literal",value:"=",description:'"="'},ut=function(e,t){return{type:"parameter",LHSValue:e?e:"",RHSValue:t?t:""}},dt=function(e,t){return{type:"csv",preAssertion:e?e:"",postAssertion:t?t:""}},pt=function(e){return e.join("")},lt=function(e){return e[1]},ht=/^[1-9]/,Et={type:"class",value:"[1-9]",description:"[1-9]"},gt=/^[0-9]/,mt={type:"class",value:"[0-9]",description:"[0-9]"},Ct=".",Nt={type:"literal",value:".",description:'"."'},It="0",Tt={type:"literal",value:"0",description:'"0"'},St=function(e){return"0"===e?"0":e[0].concat(e[1].join(""))},yt=" ",vt={type:"literal",value:" ",description:'" "'},xt=function(){return" "},wt="^",Ft={type:"literal",value:"^",description:'"^"'},Pt=function(){return"^"},At=function(e){return e},Ot="(",_t={type:"literal",value:"(",description:'"("'},Rt=function(e){return e},Dt=function(){return","},Ut=function(){return";"},Bt=function(){return"="},jt=/^[a-z]/,bt={type:"class",value:"[a-z]",description:"[a-z]"},Mt=/^[A-Z]/,Lt={type:"class",value:"[A-Z]",description:"[A-Z]"},kt="-",qt={type:"literal",value:"-",description:'"-"'},Vt="_",Ht={type:"literal",value:"_",description:'"_"'},Jt=function(e){return e},Gt=0,Wt=0,Xt=0,$t={line:1,column:1,seenCR:!1},zt=0,Zt=[],Kt=0;if("startRule"in A){if(!(A.startRule in _))throw new Error("Can't start parsing from rule \""+A.startRule+'".');R=_[A.startRule]}if(P=R(),P!==O&&Gt===e.length)return P;throw P!==O&&Gt<e.length&&n({type:"end",description:"end of input"}),i(null,Zt,zt)}return e(t,Error),{SyntaxError:t,parse:r}}(),define("readium_cfi_js/cfi_parser",function(e){return function(){var t;return t||e.EPUBcfiParser}}(this)),function(e){var t={NodeTypeError:function(e,t){function r(){this.node=e}return r.prototype=new Error(t),r.constructor=r,new r},OutOfRangeError:function(e,t,r){function n(){this.targetIndex=e,this.maxIndex=t}return n.prototype=new Error(r),n.constructor=n(),new n},TerminusError:function(e,t,r){function n(){this.terminusType=e,this.terminusCondition=t}return n.prototype=new Error(r),n.constructor=n(),new n},CFIAssertionError:function(e,t,r){function n(){this.expectedAssertion=e,this.targetElementAssertion=t}return n.prototype=new Error(r),n.constructor=n(),new n}};if("function"==typeof define&&"object"==typeof define.amd)console.log("RequireJS ... cfi_errors"),define("readium_cfi_js/cfi_runtime_errors",[],function(){return t});else{if(console.log("!RequireJS ... cfi_errors"),!e.EPUBcfi)throw new Error("EPUBcfi not initialised on global object?! (window or this context)");e.EPUBcfi.NodeTypeError=t.NodeTypeError,e.EPUBcfi.OutOfRangeError=t.OutOfRangeError,e.EPUBcfi.TerminusError=t.TerminusError,e.EPUBcfi.CFIAssertionError=t.CFIAssertionError}}("undefined"!=typeof window?window:this),function(e){var t=function(e,t){var r={getNextNode:function(e,t,r,n,i){var o;return o=e%2==0?this.elementNodeStep(e,t,r,n,i):this.inferTargetTextNode(e,t,r,n,i)},followIndirectionStep:function(r,n,i,o,a){var c,s,f,u;if(void 0===n||!n.is("iframe"))throw t.NodeTypeError(n,"expected an iframe element");return n.is("iframe")?(c=n.contents(),s=this.applyBlacklist(c.children(),i,o,a),f=e(s[0]),u=this.getNextNode(r,f,i,o,a)):void 0},textTermination:function(e,r,n){var i;if(void 0===e)throw t.NodeTypeError(e,"expected a terminating node, or node list");if(0===e.length)throw t.TerminusError("Text","Text offset:"+r,"no nodes found for termination condition");return i=this.injectCFIMarkerIntoText(e,r,n)},targetIdMatchesIdAssertion:function(e,t){return e.attr("id")===t?!0:!1},elementNodeStep:function(r,n,i,o,a){var c,s,f,u=r/2-1;if(s=this.applyBlacklist(n.children(),i,o,a),f=s.length,this.indexOutOfRange(u,f))throw t.OutOfRangeError(u,f-1,"");return c=e(s[u])},retrieveItemRefHref:function(t,r){return e("#"+t.attr("idref"),r).attr("href")},indexOutOfRange:function(e,t){return e>t-1?!0:!1},injectCFIMarkerIntoText:function(r,n,i){var o,a,c,s,f,u=r[0].ownerDocument,d=0;for(o=0;o<=r.length;o++)if(r[o].nodeType===Node.TEXT_NODE){if(currNodeMaxIndex=r[o].nodeValue.length+d,a=n-d,currNodeMaxIndex>n)return c=r[o].nodeValue,r[o].nodeValue=c.slice(0,a),s=e(i).insertAfter(r.eq(o)),f=e(u.createTextNode(c.slice(a,c.length))),e(f).insertAfter(s),s;if(currNodeMaxIndex==n)return s=e(i).insertAfter(r.eq(o));d=currNodeMaxIndex}else r[o].nodeType===Node.COMMENT_NODE?(currNodeMaxIndex=r[o].nodeValue.length+7+d,d=currNodeMaxIndex):r[o].nodeType===Node.PROCESSING_INSTRUCTION_NODE&&(currNodeMaxIndex=r[o].nodeValue.length+r[o].target.length+5,d=currNodeMaxIndex);throw t.TerminusError("Text","Text offset:"+n,"The offset exceeded the length of the text")},inferTargetTextNode:function(e,r,n,i,o){var a,c,s,f,u;if(a=this.applyBlacklist(r.contents(),n,i,o),s=(parseInt(e)+1)/2-1,c=0,u=!1,f=a.filter(function(){return c!==s?(this.nodeType===Node.TEXT_NODE||this.nodeType===Node.COMMENT_NODE||this.nodeType===Node.PROCESSING_INSTRUCTION_NODE?u=!0:u||this.nodeType!==Node.ELEMENT_NODE?u&&this.nodeType!==Node.TEXT_NODE&&this!==a.lastChild&&(c++,u=!1):(c++,u=!0),!1):this.nodeType===Node.TEXT_NODE||this.nodeType===Node.COMMENT_NODE||this.nodeType===Node.PROCESSING_INSTRUCTION_NODE?(u=!0,!0):u&&this.nodeType!==Node.TEXT_NODE?(c++,u=!1,!1):void 0}),0===f.length)throw t.OutOfRangeError(s,c,"Index out of range");return f},applyBlacklist:function(t,r,n,i){var o;return o=t.filter(function(){var t=e(this),o=!0;return r&&e.each(r,function(e,r){return t.hasClass(r)?(o=!1,!1):void 0}),n&&e.each(n,function(e,r){return t.is(r)?(o=!1,!1):void 0}),i&&e.each(i,function(e,r){return t.attr("id")===r?(o=!1,!1):void 0}),o})}};return r};if("function"==typeof define&&"object"==typeof define.amd)console.log("RequireJS ... cfi_instructions"),define("readium_cfi_js/cfi_instructions",["jquery","./cfi_runtime_errors"],function(e,r){return t(e,r)});else{if(console.log("!RequireJS ... cfi_instructions"),!e.EPUBcfi)throw new Error("EPUBcfi not initialised on global object?! (window or this context)");e.EPUBcfi.CFIInstructions=t($,{NodeTypeError:e.EPUBcfi.NodeTypeError,OutOfRangeError:e.EPUBcfi.OutOfRangeError,TerminusError:e.EPUBcfi.TerminusError,CFIAssertionError:e.EPUBcfi.CFIAssertionError})}}("undefined"!=typeof window?window:this),function(e){var t=function(e,t,r,n){if("undefined"==typeof t)throw new Error("UNDEFINED?! cfiParser");if("undefined"==typeof r)throw new Error("UNDEFINED?! cfiInstructions");if("undefined"==typeof n)throw new Error("UNDEFINED?! cfiRuntimeErrors");var i={getContentDocHref:function(r,i,o,a,c){var s=e(i),f=decodeURI(r),u=t.parse(f);if(!u||"CFIAST"!==u.type)throw n.NodeTypeError(u,"expected CFI AST root node");var d=e(e("package",s)[0]),p=this.interpretIndexStepNode(u.cfiString.path,d,o,a,c);return foundHref=this.searchLocalPathForHref(p,s,u.cfiString.localPath,o,a,c),foundHref?foundHref:void 0},injectElement:function(r,n,i,o,a,c){var s,f,u,d=decodeURI(r),p=t.parse(d);return f=this.getFirstIndirectionStepNum(p),s=p.cfiString.localPath.steps[f],s.type="indexStep",u=this.interpretLocalPath(p.cfiString.localPath,f,e("html",n),o,a,c),u=this.interpretTextTerminusNode(p.cfiString.localPath.termStep,u,i)},injectRangeElements:function(r,n,i,o,a,c,s){var f,u,d,p,l,h=decodeURI(r),E=t.parse(h);return u=this.getFirstIndirectionStepNum(E),f=E.cfiString.localPath.steps[u],f.type="indexStep",d=this.interpretLocalPath(E.cfiString.localPath,u,e("html",n),a,c,s),p=this.interpretLocalPath(E.cfiString.range1,0,d,a,c,s),p=this.interpretTextTerminusNode(E.cfiString.range1.termStep,p,i),l=this.interpretLocalPath(E.cfiString.range2,0,d,a,c,s),l=this.interpretTextTerminusNode(E.cfiString.range2.termStep,l,o),{startElement:p[0],endElement:l[0]}},getTargetElement:function(r,n,i,o,a){var c,s,f,u=decodeURI(r),d=t.parse(u);return s=this.getFirstIndirectionStepNum(d),c=d.cfiString.localPath.steps[s],c.type="indexStep",f=this.interpretLocalPath(d.cfiString.localPath,s,e("html",n),i,o,a)},getRangeTargetElements:function(r,n,i,o,a){var c,s,f,u,d,p=decodeURI(r),l=t.parse(p);s=this.getFirstIndirectionStepNum(l),c=l.cfiString.localPath.steps[s],c.type="indexStep",f=this.interpretLocalPath(l.cfiString.localPath,s,e("html",n),i,o,a),u=this.interpretLocalPath(l.cfiString.range1,0,f,i,o,a),d=this.interpretLocalPath(l.cfiString.range2,0,f,i,o,a);var h=parseInt(l.cfiString.range1.termStep.offsetValue)||void 0,E=parseInt(l.cfiString.range2.termStep.offsetValue)||void 0;return{startElement:u[0],startOffset:h,endElement:d[0],endOffset:E}},getTargetElementWithPartialCFI:function(r,n,i,o,a){var c=decodeURI(r),s=t.parse(c),f=this.interpretIndexStepNode(s.cfiString.path,e("html",n),i,o,a);return f=this.interpretLocalPath(s.cfiString.localPath,0,f,i,o,a)},getTextTerminusInfoWithPartialCFI:function(r,n,i,o,a){var c,s=decodeURI(r),f=t.parse(s),u=this.interpretIndexStepNode(f.cfiString.path,e("html",n),i,o,a);return u=this.interpretLocalPath(f.cfiString.localPath,0,u,i,o,a),c=parseInt(f.cfiString.localPath.termStep.offsetValue),{textNode:u,textOffset:c}},isRangeCfi:function(e){var r=t.parse(e);return r.cfiString.range1?!0:!1},getFirstIndirectionStepNum:function(e){var t=0;for(t;t<=e.cfiString.localPath.steps.length-1;t++)if(nextStepNode=e.cfiString.localPath.steps[t],"indirectionStep"===nextStepNode.type)return t},interpretLocalPath:function(e,t,r,n,i,o){var a,c=t;for(c;c<=e.steps.length-1;c++)a=e.steps[c],"indexStep"===a.type?r=this.interpretIndexStepNode(a,r,n,i,o):"indirectionStep"===a.type&&(r=this.interpretIndirectionStepNode(a,r,n,i,o));return r},interpretIndexStepNode:function(e,t,i,o,a){if(void 0===e||"indexStep"!==e.type)throw n.NodeTypeError(e,"expected index step node");var c=r.getNextNode(e.stepLength,t,i,o,a);if(e.idAssertion&&!r.targetIdMatchesIdAssertion(c,e.idAssertion))throw n.CFIAssertionError(e.idAssertion,c.attr("id"),"Id assertion failed");return c},interpretIndirectionStepNode:function(e,t,i,o){if(void 0===e||"indirectionStep"!==e.type)throw n.NodeTypeError(e,"expected indirection step node");var a=r.followIndirectionStep(e.stepLength,t,i,o);if(e.idAssertion&&!r.targetIdMatchesIdAssertion(a,e.idAssertion))throw n.CFIAssertionError(e.idAssertion,a.attr("id"),"Id assertion failed");return a},interpretTextTerminusNode:function(e,t,i){if(void 0===e||"textTerminus"!==e.type)throw n.NodeTypeError(e,"expected text terminus node");var o=r.textTermination(t,e.offsetValue,i);return o},searchLocalPathForHref:function(e,t,n,i,o,a){var c,s=0;for(s=0;s<=n.steps.length-1;s++)if(c=n.steps[s],"indexStep"===c.type?e=this.interpretIndexStepNode(c,e,i,o,a):"indirectionStep"===c.type&&(e=this.interpretIndirectionStepNode(c,e,i,o,a)),e.is("itemref"))return r.retrieveItemRefHref(e,t);return void 0}};return i};if("function"==typeof define&&"object"==typeof define.amd)console.log("RequireJS ... cfi_interpreter"),define("readium_cfi_js/cfi_interpreter",["jquery","readium_cfi_js/cfi_parser","./cfi_instructions","./cfi_runtime_errors"],function(e,r,n,i){return t(e,r,n,i)});else{if(console.log("!RequireJS ... cfi_interpreter"),!e.EPUBcfi)throw new Error("EPUBcfi not initialised on global object?! (window or this context)");e.EPUBcfi.Interpreter=t($,e.EPUBcfi.Parser,e.EPUBcfi.CFIInstructions,{NodeTypeError:e.EPUBcfi.NodeTypeError,OutOfRangeError:e.EPUBcfi.OutOfRangeError,TerminusError:e.EPUBcfi.TerminusError,CFIAssertionError:e.EPUBcfi.CFIAssertionError})}}("undefined"!=typeof window?window:this),function(e){var t=function(e,t,r){if("undefined"==typeof t)throw new Error("UNDEFINED?! cfiInstructions");if("undefined"==typeof r)throw new Error("UNDEFINED?! cfiRuntimeErrors");var n={generateCharOffsetRangeComponent:function(t,r,n,i,o,a,c){var s,f,u,d,p,l,h,E,g,m=t.ownerDocument;return this.validateStartTextNode(t),this.validateStartTextNode(n),e(t).parent()[0]===e(n).parent()[0]?(p=this.createCFITextNodeStep(e(t),r,o,a,c),h=this.createCFITextNodeStep(e(n),i,o,a,c),g=this.createCFIElementSteps(e(t).parent(),"html",o,a,c),g.substring(1,g.length)+","+p+","+h):(s=m.createRange(),s.setStart(t,r),s.setEnd(n,i),f=s.commonAncestorContainer,p=this.createCFITextNodeStep(e(t),r,o,a,c),u=e(t).parent(),l=u[0]===f?p:this.createCFIElementSteps(u,f,o,a,c)+p,h=this.createCFITextNodeStep(e(n),i,o,a,c),d=e(n).parent(),E=d[0]===f?h:this.createCFIElementSteps(d,f,o,a,c)+h,g=this.createCFIElementSteps(e(f),"html",o,a,c),g.substring(1,g.length)+","+l+","+E)},generateElementRangeComponent:function(t,r,n,i,o){var a,c,s,f,u,d=t.ownerDocument;if(this.validateStartElement(t),this.validateStartElement(r),t===r)throw new Error("Start and end element cannot be the same for a CFI range");return a=d.createRange(),a.setStart(t,0),a.setEnd(r,r.childNodes.length),c=a.commonAncestorContainer,s=this.createCFIElementSteps(e(t),c,n,i,o),f=this.createCFIElementSteps(e(r),c,n,i,o),u=this.createCFIElementSteps(e(c),"html",n,i,o),u.substring(1,u.length)+","+s+","+f},generateRangeComponent:function(t,r,n,i,o,a,c){var s=t.ownerDocument;if(t.nodeType===Node.ELEMENT_NODE&&n.nodeType===Node.ELEMENT_NODE)return this.generateElementRangeComponent(t,n,o,a,c);if(t.nodeType===Node.TEXT_NODE&&n.nodeType===Node.TEXT_NODE)return this.generateCharOffsetRangeComponent(t,r,n,i,o,a,c);var f,u,d,p,l,h,E;return f=s.createRange(),f.setStart(t,r),f.setEnd(n,i),h=f.commonAncestorContainer,t.nodeType===Node.ELEMENT_NODE?(this.validateStartElement(t),u=this.createCFIElementSteps(e(t),h,o,a,c)):(this.validateStartTextNode(t),d=this.createCFITextNodeStep(e(t),r,o,a,c),u=e(t).parent().is(h)?d:this.createCFIElementSteps(e(t).parent(),h,o,a,c)+d),n.nodeType===Node.ELEMENT_NODE?(this.validateStartElement(n),p=this.createCFIElementSteps(e(n),h,o,a,c)):(this.validateStartTextNode(n),l=this.createCFITextNodeStep(e(n),i,o,a,c),p=e(n).parent().is(h)?l:this.createCFIElementSteps(e(n).parent(),h,o,a,c)+l),E=this.createCFIElementSteps(e(h),"html",o,a,c),E.substring(1,E.length)+","+u+","+p},generateCharacterOffsetCFIComponent:function(t,r,n,i,o){var a,c;return this.validateStartTextNode(t,r),a=this.createCFITextNodeStep(e(t),r,n,i,o),c=this.createCFIElementSteps(e(t).parent(),"html",n,i,o)+a,c.substring(1,c.length)},generateElementCFIComponent:function(t,r,n,i){var o;return this.validateStartElement(t),o=this.createCFIElementSteps(e(t),"html",r,n,i),o.substring(1,o.length)},generatePackageDocumentCFIComponent:function(t,r,n,i,o){return this.validateContentDocumentName(t),this.validatePackageDocument(r,t),$itemRefStartNode=e("itemref[idref='"+t+"']",e(r)),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",n,i,o),packageDocCFIComponent+"!"},generatePackageDocumentCFIComponentWithSpineIndex:function(t,r,n,i,o){return $itemRefStartNode=e(e("spine",r).children()[t]),packageDocCFIComponent=this.createCFIElementSteps($itemRefStartNode,"package",n,i,o),packageDocCFIComponent+"!"},generateCompleteCFI:function(e,t){return"epubcfi("+e+t+")"},validateStartTextNode:function(e,t){if(!e)throw new r.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(3!=e.nodeType)throw new r.NodeTypeError(e,"Cannot generate a character offset from a starting point that is not a text node");if(0>t)throw new r.OutOfRangeError(t,0,"Character offset cannot be less than 0");if(t>e.nodeValue.length)throw new r.OutOfRangeError(t,e.nodeValue.length-1,"character offset cannot be greater than the length of the text node")},validateStartElement:function(e){if(!e)throw new r.NodeTypeError(e,"CFI target element is undefined");if(!e.nodeType||1!==e.nodeType)throw new r.NodeTypeError(e,"CFI target element is not an HTML element")},validateContentDocumentName:function(e){if(!e)throw new Error("The idref for the content document, as found in the spine, must be supplied")},validatePackageDocument:function(t,r){if(!t)throw new Error("A package document must be supplied to generate a CFI");if(0===e(e("itemref[idref='"+r+"']",t)[0]).length)throw new Error("The idref of the content document could not be found in the spine")},createCFITextNodeStep:function(r,n,i,o,a){var c,s,f,u;c=r.parent(),s=t.applyBlacklist(c.contents(),i,o,a);var d,p,l=0,h=0,E=0;return e.each(s,function(){if(this.nodeType!==Node.TEXT_NODE&&d)this.nodeType===Node.ELEMENT_NODE?(d=!1,p=void 0,h=0):this.nodeType===Node.COMMENT_NODE?h=h+this.length+7:this.nodeType===Node.PROCESSING_INSTRUCTION_NODE&&(h=h+this.data.length+this.target.length+5);else if(this.nodeType===Node.TEXT_NODE){if(this===r[0])return d?(u=p,E=h):u=l,!1;d=!0,h+=this.length,void 0===p&&(p=l,l+=1)}else this.nodeType===Node.ELEMENT_NODE?l+=1:this.nodeType===Node.COMMENT_NODE?(d=!0,h=h+this.length+7,void 0===p&&(p=l)):this.nodeType===Node.PROCESSING_INSTRUCTION_NODE&&(d=!0,h=h+this.data.length+this.target.length+5,void 0===p&&(p=l))}),f=2*u+1,"/"+f+":"+(E+n)},createCFIElementSteps:function(r,n,i,o,a){var c,s,f,u,d;return r[0]===n?"":(c=t.applyBlacklist(r.parent().children(),i,o,a),e.each(c,function(e){return this===r[0]?(f=e,!1):void 0}),u=2*(f+1),d=r.attr("id")?"/"+u+"["+r.attr("id")+"]":"/"+u,s=r.parent(),s.is(n)||r.is(n)?"html"===n?"!"+d:d:this.createCFIElementSteps(s,n,i,o,a)+d)}};return n};if("function"==typeof define&&"object"==typeof define.amd)console.log("RequireJS ... cfi_generator"),define("readium_cfi_js/cfi_generator",["jquery","./cfi_instructions","./cfi_runtime_errors"],function(e,r,n){return t(e,r,n)});else{if(console.log("!RequireJS ... cfi_generator"),!e.EPUBcfi)throw new Error("EPUBcfi not initialised on global object?! (window or this context)");e.EPUBcfi.Generator=t($,e.EPUBcfi.CFIInstructions,{NodeTypeError:e.EPUBcfi.NodeTypeError,OutOfRangeError:e.EPUBcfi.OutOfRangeError,TerminusError:e.EPUBcfi.TerminusError,CFIAssertionError:e.EPUBcfi.CFIAssertionError})}}("undefined"!=typeof window?window:this),function(e){var t=function(t,r,n,i,o){if("undefined"==typeof t)throw new Error("UNDEFINED?! cfiParser");if("undefined"==typeof r)throw new Error("UNDEFINED?! cfiInterpreter");if("undefined"==typeof n)throw new Error("UNDEFINED?! cfiInstructions");if("undefined"==typeof i)throw new Error("UNDEFINED?! cfiRuntimeErrors");if("undefined"==typeof o)throw new Error("UNDEFINED?! cfiGenerator");var a={getContentDocHref:function(e,t){return r.getContentDocHref(e,t)},injectElement:function(e,t,n,i,o,a){return r.injectElement(e,t,n,i,o,a)},getTargetElement:function(e,t,n,i,o){return r.getTargetElement(e,t,n,i,o)},getTargetElementWithPartialCFI:function(e,t,n,i,o){return r.getTargetElementWithPartialCFI(e,t,n,i,o)},injectRangeElements:function(e,t,n,i,o,a,c){return r.injectRangeElements(e,t,n,i,o,a,c)},getRangeTargetElements:function(e,t,n,i,o){return r.getRangeTargetElements(e,t,n,i,o)},isRangeCfi:function(e){return r.isRangeCfi(e)},getTextTerminusInfoWithPartialCFI:function(e,t,n,i,o){return r.getTextTerminusInfoWithPartialCFI(e,t,n,i,o)},generateCharacterOffsetCFIComponent:function(e,t,r,n,i){return o.generateCharacterOffsetCFIComponent(e,t,r,n,i)},generateElementCFIComponent:function(e,t,r,n){return o.generateElementCFIComponent(e,t,r,n)},generatePackageDocumentCFIComponent:function(e,t,r,n,i){return o.generatePackageDocumentCFIComponent(e,t,r,n,i)},generatePackageDocumentCFIComponentWithSpineIndex:function(e,t,r,n,i){return o.generatePackageDocumentCFIComponentWithSpineIndex(e,t,r,n,i)},generateCompleteCFI:function(e,t){return o.generateCompleteCFI(e,t)},generateCharOffsetRangeComponent:function(e,t,r,n,i,a,c){return o.generateCharOffsetRangeComponent(e,t,r,n,i,a,c)},generateElementRangeComponent:function(e,t,r,n,i){return o.generateElementRangeComponent(e,t,r,n,i)},generateRangeComponent:function(e,t,r,n,i,a,c){return o.generateRangeComponent(e,t,r,n,i,a,c)},injectElementAtOffset:function(e,t,r){return n.injectCFIMarkerIntoText(e,t,r)}};return a.CFIInstructions=n,a.Parser=t,a.Interpreter=r,a.Generator=o,a.NodeTypeError=i.NodeTypeError,a.OutOfRangeError=i.OutOfRangeError,a.TerminusError=i.TerminusError,a.CFIAssertionError=i.CFIAssertionError,e.EPUBcfi=a,console.log("#######################################"),a};if("function"==typeof define&&"object"==typeof define.amd)console.log("RequireJS ... cfi_API"),define("readium_cfi_js/cfi_API",["readium_cfi_js/cfi_parser","./cfi_interpreter","./cfi_instructions","./cfi_runtime_errors","./cfi_generator"],function(e,r,n,i,o){return t(e,r,n,i,o)});else{if(console.log("!RequireJS ... cfi_API"),!e.EPUBcfi)throw new Error("EPUBcfi not initialised on global object?! (window or this context)");t(e.EPUBcfi.Parser,e.EPUBcfi.Interpreter,e.EPUBcfi.CFIInstructions,{NodeTypeError:e.EPUBcfi.NodeTypeError,OutOfRangeError:e.EPUBcfi.OutOfRangeError,TerminusError:e.EPUBcfi.TerminusError,CFIAssertionError:e.EPUBcfi.CFIAssertionError},e.EPUBcfi.Generator)}}("undefined"!=typeof window?window:this),define("readium_cfi_js",["readium_cfi_js/cfi_API"],function(e){return e}),define("readium-cfi-js",function(){}),require(["readium_cfi_js/cfi_API"]);
//# sourceMappingURL=readium-cfi-js.js.map